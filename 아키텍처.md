# 웹 스크래핑 자동화 빌더 - 시스템 아키텍처

> 작성일: 2025-11-30  
> 상태: 설계 중

---

## 1. 시스템 개요

### 1.1 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              사용자 접점                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │   웹 앱      │    │Chrome 확장   │    │   모바일     │                   │
│  │  (Next.js)   │    │  프로그램    │    │  (추후)      │                   │
│  └──────┬───────┘    └──────┬───────┘    └──────────────┘                   │
│         │                   │                                                │
│         └─────────┬─────────┘                                                │
│                   │                                                          │
│                   ▼                                                          │
│         ┌─────────────────┐                                                  │
│         │   Vercel Edge   │  ← CDN, 정적 자산, SSR                          │
│         └────────┬────────┘                                                  │
│                  │                                                           │
└──────────────────┼───────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                     FastAPI (Railway)                                 │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐        │   │
│  │  │ Auth API   │ │ Bot API    │ │ Schedule   │ │ Export API │        │   │
│  │  │            │ │            │ │ API        │ │            │        │   │
│  │  │ - 로그인   │ │ - CRUD     │ │ - 생성     │ │ - Sheets   │        │   │
│  │  │ - OAuth    │ │ - 실행     │ │ - 수정     │ │ - Webhook  │        │   │
│  │  │ - 토큰     │ │ - 테스트   │ │ - 이력     │ │ - 다운로드 │        │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘        │   │
│  │                                                                       │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                        │   │
│  │  │ Payment    │ │ Usage API  │ │ LLM API    │                        │   │
│  │  │ API        │ │            │ │            │                        │   │
│  │  │ - 토스     │ │ - 사용량   │ │ - 추출     │                        │   │
│  │  │ - Stripe   │ │ - 제한     │ │ - 정제     │                        │   │
│  │  └────────────┘ └────────────┘ └────────────┘                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Worker Layer                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      Celery + Redis                                  │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │    │
│  │  │ Task Queue  │  │ Celery Beat │  │   Flower    │                  │    │
│  │  │ (작업 대기) │  │ (스케줄러)  │  │ (모니터링) │                  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                              │                                               │
│                              ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     Celery Workers                                   │    │
│  │                                                                      │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│  │  │ Worker 1 │  │ Worker 2 │  │ Worker 3 │  │ Worker N │            │    │
│  │  │          │  │          │  │          │  │          │            │    │
│  │  │ Scraping │  │ Scraping │  │ LLM      │  │ Export   │            │    │
│  │  │ Tasks    │  │ Tasks    │  │ Tasks    │  │ Tasks    │            │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        External Services                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Firecrawl  │  │  OpenRouter │  │   Google    │  │    Slack    │        │
│  │  (스크래핑) │  │  (LLM API)  │  │   Sheets    │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │ 토스페이먼츠│  │   Stripe    │  │   Proxy     │                         │
│  │  (한국결제) │  │ (글로벌)    │  │   Pool      │                         │
│  └─────────────┘  └─────────────┘  └─────────────┘                         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Data Layer                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   PostgreSQL    │  │      Redis      │  │    S3/Storage   │             │
│  │                 │  │                 │  │                 │             │
│  │  - Users        │  │  - Session      │  │  - Screenshots  │             │
│  │  - Bots         │  │  - Cache        │  │  - Exports      │             │
│  │  - Schedules    │  │  - Task Queue   │  │  - Logs         │             │
│  │  - Results      │  │  - Rate Limit   │  │                 │             │
│  │  - Payments     │  │                 │  │                 │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트 상세

### 2.1 Frontend (Next.js + React)

```
frontend/
├── app/                      # Next.js 14 App Router
│   ├── (auth)/              # 인증 관련 페이지
│   │   ├── login/
│   │   ├── register/
│   │   └── oauth/
│   ├── (dashboard)/         # 대시보드
│   │   ├── bots/           # 봇 목록/관리
│   │   ├── schedules/      # 스케줄 관리
│   │   ├── results/        # 결과 조회
│   │   └── settings/       # 설정
│   ├── (builder)/          # 봇 빌더
│   │   └── editor/[id]/
│   └── (marketing)/        # 랜딩/가격 페이지
│       ├── page.tsx        # 랜딩
│       └── pricing/
│
├── components/
│   ├── builder/            # 봇 빌더 컴포넌트
│   │   ├── Canvas.tsx      # React Flow 캔버스
│   │   ├── NodePalette.tsx # 노드 팔레트
│   │   ├── nodes/          # 커스텀 노드들
│   │   │   ├── NavigateNode.tsx
│   │   │   ├── ClickNode.tsx
│   │   │   ├── ExtractNode.tsx
│   │   │   ├── LoopNode.tsx
│   │   │   └── ...
│   │   └── PropertyPanel.tsx
│   │
│   ├── selector/           # 셀렉터 컴포넌트
│   │   ├── IframeSelector.tsx   # 무료 티어
│   │   └── ExtensionBridge.tsx  # 확장 프로그램 연동
│   │
│   └── ui/                 # 공통 UI (shadcn/ui)
│
├── lib/
│   ├── api/               # API 클라이언트
│   ├── stores/            # Zustand 스토어
│   └── utils/
│
└── hooks/                 # 커스텀 훅
```

#### 주요 라이브러리
| 용도 | 라이브러리 |
|------|-----------|
| 상태 관리 | Zustand |
| 워크플로우 빌더 | React Flow |
| UI 컴포넌트 | shadcn/ui + Tailwind |
| 폼 처리 | React Hook Form + Zod |
| API 통신 | TanStack Query |
| 인증 | NextAuth.js |

---

### 2.2 Backend (FastAPI)

```
backend/
├── app/
│   ├── main.py              # FastAPI 앱 진입점
│   ├── config.py            # 설정 (환경변수)
│   │
│   ├── api/                 # API 라우터
│   │   ├── v1/
│   │   │   ├── auth.py      # 인증 API
│   │   │   ├── bots.py      # 봇 CRUD
│   │   │   ├── schedules.py # 스케줄 관리
│   │   │   ├── executions.py# 실행 및 결과
│   │   │   ├── exports.py   # 내보내기
│   │   │   ├── payments.py  # 결제
│   │   │   └── users.py     # 사용자 관리
│   │   └── deps.py          # 의존성 (인증 등)
│   │
│   ├── models/              # SQLAlchemy 모델
│   │   ├── user.py
│   │   ├── bot.py
│   │   ├── schedule.py
│   │   ├── execution.py
│   │   └── payment.py
│   │
│   ├── schemas/             # Pydantic 스키마
│   │   ├── user.py
│   │   ├── bot.py
│   │   └── ...
│   │
│   ├── services/            # 비즈니스 로직
│   │   ├── auth_service.py
│   │   ├── bot_service.py
│   │   ├── scraping_service.py
│   │   ├── llm_service.py
│   │   └── export_service.py
│   │
│   ├── workers/             # Celery 태스크
│   │   ├── celery_app.py    # Celery 설정
│   │   ├── scraping_tasks.py
│   │   ├── llm_tasks.py
│   │   ├── export_tasks.py
│   │   └── schedule_tasks.py
│   │
│   └── utils/
│       ├── security.py      # JWT, 해싱
│       ├── rate_limiter.py
│       └── validators.py
│
├── alembic/                 # DB 마이그레이션
├── tests/
└── requirements.txt
```

#### API 엔드포인트 개요

```
Auth
├── POST   /api/v1/auth/register
├── POST   /api/v1/auth/login
├── POST   /api/v1/auth/logout
├── POST   /api/v1/auth/refresh
├── GET    /api/v1/auth/oauth/{provider}
└── GET    /api/v1/auth/oauth/{provider}/callback

Bots
├── GET    /api/v1/bots                    # 목록
├── POST   /api/v1/bots                    # 생성
├── GET    /api/v1/bots/{id}               # 상세
├── PUT    /api/v1/bots/{id}               # 수정
├── DELETE /api/v1/bots/{id}               # 삭제
├── POST   /api/v1/bots/{id}/test          # 테스트 실행
└── POST   /api/v1/bots/{id}/execute       # 즉시 실행

Schedules
├── GET    /api/v1/schedules
├── POST   /api/v1/schedules
├── PUT    /api/v1/schedules/{id}
├── DELETE /api/v1/schedules/{id}
└── POST   /api/v1/schedules/{id}/toggle   # 활성화/비활성화

Executions
├── GET    /api/v1/executions              # 실행 이력
├── GET    /api/v1/executions/{id}         # 상세 (로그 포함)
├── GET    /api/v1/executions/{id}/result  # 결과 데이터
└── POST   /api/v1/executions/{id}/cancel  # 취소

Exports
├── GET    /api/v1/exports/destinations    # 연결된 목적지
├── POST   /api/v1/exports/google-sheets   # Google Sheets 연동
├── POST   /api/v1/exports/webhook         # Webhook 설정
└── POST   /api/v1/exports/{exec_id}/send  # 결과 내보내기

Users
├── GET    /api/v1/users/me                # 내 정보
├── PUT    /api/v1/users/me                # 정보 수정
├── GET    /api/v1/users/usage             # 사용량 조회
└── DELETE /api/v1/users/me                # 계정 삭제

Payments
├── GET    /api/v1/payments/plans          # 요금제 목록
├── POST   /api/v1/payments/subscribe      # 구독 시작
├── POST   /api/v1/payments/cancel         # 구독 취소
├── GET    /api/v1/payments/invoices       # 청구 내역
└── POST   /api/v1/payments/webhook        # 결제 웹훅 (토스/Stripe)
```

---

### 2.3 Worker Layer (Celery)

```python
# workers/celery_app.py

from celery import Celery

app = Celery('scraper')
app.config_from_object('app.config.CeleryConfig')

# 태스크 큐 설정
app.conf.task_queues = {
    'scraping': {'exchange': 'scraping', 'routing_key': 'scraping'},
    'llm': {'exchange': 'llm', 'routing_key': 'llm'},
    'export': {'exchange': 'export', 'routing_key': 'export'},
    'default': {'exchange': 'default', 'routing_key': 'default'},
}

# 우선순위 설정 (유료 > 무료)
app.conf.task_default_priority = 5
```

#### 태스크 워크플로우

```python
# workers/scraping_tasks.py

from celery import chain, group, chord

@app.task(bind=True, queue='scraping')
def execute_bot(self, bot_id: str, execution_id: str):
    """봇 실행 메인 태스크"""
    
    # 워크플로우 체이닝
    workflow = chain(
        # 1. URL 수집 (Firecrawl map)
        collect_urls.s(bot_id),
        
        # 2. 병렬 스크래핑 (Firecrawl scrape)
        scrape_pages_group.s(),
        
        # 3. LLM 데이터 정제
        process_with_llm.s(bot_id),
        
        # 4. 결과 저장
        save_results.s(execution_id),
        
        # 5. 내보내기 (설정된 경우)
        export_if_configured.s(execution_id),
    )
    
    return workflow.apply_async()


@app.task(queue='scraping')
def collect_urls(bot_id: str) -> list[str]:
    """Firecrawl map으로 URL 수집"""
    bot = get_bot(bot_id)
    
    # Firecrawl MCP 호출
    result = firecrawl.map(
        url=bot.start_url,
        options={
            'limit': bot.max_pages,
            'includePatterns': bot.url_patterns,
        }
    )
    
    return result.urls


@app.task(queue='scraping')
def scrape_pages_group(urls: list[str]) -> list[dict]:
    """여러 페이지 병렬 스크래핑"""
    
    # group으로 병렬 처리
    job = group(scrape_single_page.s(url) for url in urls)
    result = job.apply_async()
    
    return result.get()


@app.task(queue='scraping', rate_limit='10/m')  # 분당 10회 제한
def scrape_single_page(url: str) -> dict:
    """단일 페이지 스크래핑"""
    
    result = firecrawl.scrape(
        url=url,
        options={
            'formats': ['markdown', 'html'],
            'waitFor': 2000,  # JS 렌더링 대기
        }
    )
    
    return {
        'url': url,
        'markdown': result.markdown,
        'html': result.html,
    }


@app.task(queue='llm')
def process_with_llm(pages: list[dict], bot_id: str) -> list[dict]:
    """LLM으로 데이터 추출/정제"""
    
    bot = get_bot(bot_id)
    
    results = []
    for page in pages:
        extracted = llm_service.extract(
            content=page['markdown'],
            schema=bot.extraction_schema,  # 사용자 정의 스키마
            prompt=bot.extraction_prompt,
        )
        results.append({
            'url': page['url'],
            'data': extracted,
        })
    
    return results
```

#### Celery Beat (스케줄러)

```python
# workers/schedule_tasks.py

from celery.schedules import crontab

app.conf.beat_schedule = {
    # 스케줄된 봇 실행 체크 (매분)
    'check-scheduled-bots': {
        'task': 'workers.schedule_tasks.check_and_run_scheduled',
        'schedule': crontab(minute='*'),
    },
    
    # 사용량 리셋 (매월 1일)
    'reset-monthly-usage': {
        'task': 'workers.schedule_tasks.reset_usage',
        'schedule': crontab(day_of_month='1', hour='0', minute='0'),
    },
    
    # 오래된 결과 정리 (매일)
    'cleanup-old-results': {
        'task': 'workers.schedule_tasks.cleanup_results',
        'schedule': crontab(hour='3', minute='0'),
    },
}


@app.task
def check_and_run_scheduled():
    """스케줄된 봇 확인 및 실행"""
    
    now = datetime.utcnow()
    
    # 실행할 스케줄 조회
    schedules = Schedule.query.filter(
        Schedule.is_active == True,
        Schedule.next_run <= now,
    ).all()
    
    for schedule in schedules:
        # 사용량 체크
        if not check_usage_limit(schedule.user_id):
            notify_limit_exceeded(schedule.user_id)
            continue
        
        # 실행 생성 및 태스크 시작
        execution = create_execution(schedule.bot_id)
        execute_bot.delay(schedule.bot_id, execution.id)
        
        # 다음 실행 시간 계산
        schedule.next_run = calculate_next_run(schedule.cron_expression)
        schedule.save()
```

---

### 2.4 Chrome 확장 프로그램

```
chrome-extension/
├── manifest.json
├── src/
│   ├── background/
│   │   └── service-worker.ts    # 백그라운드 서비스
│   │
│   ├── content/
│   │   ├── selector.ts          # 요소 선택 로직
│   │   ├── highlighter.ts       # 하이라이트 UI
│   │   └── injected.css
│   │
│   ├── popup/
│   │   ├── Popup.tsx            # 팝업 UI
│   │   └── index.html
│   │
│   └── lib/
│       ├── messaging.ts         # 웹앱 ↔ 확장 통신
│       └── selector-generator.ts # CSS/XPath 생성
│
└── webpack.config.js
```

#### 웹앱 ↔ 확장 프로그램 통신

```typescript
// lib/messaging.ts

// 웹앱에서 확장 프로그램으로 메시지 전송
export async function sendToExtension(action: string, data: any) {
  return new Promise((resolve) => {
    window.postMessage({
      type: 'SCRAPER_WEBAPP_TO_EXTENSION',
      action,
      data,
    }, '*');
    
    window.addEventListener('message', function handler(event) {
      if (event.data.type === 'SCRAPER_EXTENSION_TO_WEBAPP') {
        window.removeEventListener('message', handler);
        resolve(event.data.result);
      }
    });
  });
}

// 사용 예시
const selector = await sendToExtension('START_SELECTION', {
  url: 'https://example.com',
});
// 결과: { css: 'div.product > h2', xpath: '//div[@class="product"]/h2' }
```

---

## 3. 데이터 모델

### 3.1 ERD (Entity Relationship Diagram)

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│      User       │       │       Bot       │       │    Schedule     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │───┐   │ id (PK)         │───┐   │ id (PK)         │
│ email           │   │   │ user_id (FK)    │──┐│   │ bot_id (FK)     │───┐
│ password_hash   │   │   │ name            │  ││   │ cron_expression │   │
│ oauth_provider  │   │   │ description     │  ││   │ timezone        │   │
│ plan            │   └──▶│ start_url       │  ││   │ is_active       │   │
│ usage_count     │       │ workflow_json   │  ││   │ next_run        │   │
│ usage_limit     │       │ extraction_schema│  ││   │ created_at      │   │
│ created_at      │       │ created_at      │  ││   └─────────────────┘   │
└─────────────────┘       └─────────────────┘  ││                         │
                                               ││                         │
                          ┌────────────────────┘│                         │
                          │                     │                         │
                          ▼                     ▼                         │
┌─────────────────┐       ┌─────────────────┐                             │
│   Execution     │       │ ExportDestination│                            │
├─────────────────┤       ├─────────────────┤                             │
│ id (PK)         │◀──────│ id (PK)         │                             │
│ bot_id (FK)     │───────│ user_id (FK)    │                             │
│ schedule_id (FK)│◀──────│ type            │  (google_sheets, webhook)   │
│ status          │       │ config_json     │                             │
│ started_at      │       │ created_at      │                             │
│ finished_at     │       └─────────────────┘                             │
│ rows_collected  │                                                       │
│ error_message   │       ┌─────────────────┐                             │
│ result_json     │       │    Payment      │                             │
└─────────────────┘       ├─────────────────┤                             │
        │                 │ id (PK)         │                             │
        │                 │ user_id (FK)    │                             │
        ▼                 │ amount          │                             │
┌─────────────────┐       │ currency        │                             │
│ ExecutionLog    │       │ status          │                             │
├─────────────────┤       │ provider        │  (toss, stripe)             │
│ id (PK)         │       │ provider_id     │                             │
│ execution_id(FK)│       │ created_at      │                             │
│ level           │       └─────────────────┘                             │
│ message         │                                                       │
│ timestamp       │       ┌─────────────────┐                             │
└─────────────────┘       │ Subscription    │                             │
                          ├─────────────────┤                             │
                          │ id (PK)         │                             │
                          │ user_id (FK)    │                             │
                          │ plan            │                             │
                          │ status          │                             │
                          │ current_period_start │                        │
                          │ current_period_end   │                        │
                          │ cancel_at       │                             │
                          └─────────────────┘                             │
```

### 3.2 주요 모델 정의

```python
# models/bot.py

from sqlalchemy import Column, String, JSON, ForeignKey, DateTime
from sqlalchemy.dialects.postgresql import UUID
import uuid

class Bot(Base):
    __tablename__ = 'bots'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'), nullable=False)
    
    name = Column(String(255), nullable=False)
    description = Column(String(1000))
    
    start_url = Column(String(2048), nullable=False)
    url_patterns = Column(JSON)  # 크롤링할 URL 패턴
    
    # React Flow에서 생성한 워크플로우
    workflow_json = Column(JSON, nullable=False)
    # {
    #   "nodes": [...],
    #   "edges": [...],
    # }
    
    # LLM 추출용 스키마
    extraction_schema = Column(JSON)
    # {
    #   "fields": [
    #     {"name": "title", "type": "string", "description": "상품명"},
    #     {"name": "price", "type": "number", "description": "가격"},
    #   ]
    # }
    
    extraction_prompt = Column(String(2000))
    
    max_pages = Column(Integer, default=10)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    
    # Relationships
    user = relationship('User', back_populates='bots')
    schedules = relationship('Schedule', back_populates='bot')
    executions = relationship('Execution', back_populates='bot')
```

---

## 4. 데이터 흐름

### 4.1 봇 생성 및 실행 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           봇 생성 흐름                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  사용자   │    │  웹 앱   │    │  확장    │    │  API     │    │   DB     │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │               │
     │  1. 새 봇 생성 클릭           │               │               │
     │──────────────▶│               │               │               │
     │               │               │               │               │
     │               │  2. URL 입력 & 셀렉터 시작    │               │
     │               │──────────────▶│               │               │
     │               │               │               │               │
     │               │               │  3. 페이지 열기 & 요소 선택   │
     │               │◀──────────────│               │               │
     │               │               │               │               │
     │  4. 워크플로우 빌더에서 노드 추가             │               │
     │──────────────▶│               │               │               │
     │               │               │               │               │
     │  5. 저장 클릭  │               │               │               │
     │──────────────▶│               │               │               │
     │               │               │               │               │
     │               │  6. POST /api/v1/bots         │               │
     │               │──────────────────────────────▶│               │
     │               │               │               │               │
     │               │               │               │  7. 저장      │
     │               │               │               │──────────────▶│
     │               │               │               │               │
     │               │  8. 봇 생성 완료              │               │
     │◀──────────────│◀──────────────────────────────│               │
     │               │               │               │               │


┌─────────────────────────────────────────────────────────────────────────────┐
│                           봇 실행 흐름                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────┐
│  사용자   │  │  웹 앱   │  │  API     │  │  Celery  │  │Firecrawl │  │ LLM  │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └──┬───┘
     │             │             │             │             │           │
     │  실행 클릭   │             │             │             │           │
     │────────────▶│             │             │             │           │
     │             │             │             │             │           │
     │             │ POST /bots/{id}/execute   │             │           │
     │             │────────────▶│             │             │           │
     │             │             │             │             │           │
     │             │             │ 태스크 큐잉 │             │           │
     │             │             │────────────▶│             │           │
     │             │             │             │             │           │
     │             │ execution_id│             │             │           │
     │◀────────────│◀────────────│             │             │           │
     │             │             │             │             │           │
     │             │             │             │  1. map()   │           │
     │             │             │             │────────────▶│           │
     │             │             │             │   URLs      │           │
     │             │             │             │◀────────────│           │
     │             │             │             │             │           │
     │             │             │             │  2. scrape()│           │
     │             │             │             │────────────▶│           │
     │             │             │             │   Content   │           │
     │             │             │             │◀────────────│           │
     │             │             │             │             │           │
     │             │             │             │  3. extract()           │
     │             │             │             │────────────────────────▶│
     │             │             │             │   Structured Data       │
     │             │             │             │◀────────────────────────│
     │             │             │             │             │           │
     │             │             │  4. 결과 저장             │           │
     │             │             │◀────────────│             │           │
     │             │             │             │             │           │
     │  WebSocket: 진행상황      │             │             │           │
     │◀────────────│◀────────────│             │             │           │
     │             │             │             │             │           │
     │  완료 알림   │             │             │             │           │
     │◀────────────│             │             │             │           │
```

### 4.2 스케줄 실행 흐름

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                   │
│   Celery Beat                                                     │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  매분 실행: check_and_run_scheduled()                    │    │
│   └─────────────────────────────────────────────────────────┘    │
│                              │                                    │
│                              ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  1. 현재 시간 기준 실행할 스케줄 조회                    │    │
│   │     SELECT * FROM schedules                              │    │
│   │     WHERE is_active = true AND next_run <= NOW()         │    │
│   └─────────────────────────────────────────────────────────┘    │
│                              │                                    │
│                              ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  2. 각 스케줄에 대해:                                    │    │
│   │     a. 사용량 체크 (usage_count < usage_limit)           │    │
│   │     b. Execution 레코드 생성                             │    │
│   │     c. execute_bot.delay(bot_id, execution_id)           │    │
│   │     d. next_run 업데이트 (cron 파싱)                     │    │
│   └─────────────────────────────────────────────────────────┘    │
│                              │                                    │
│                              ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  3. 워커가 태스크 처리                                   │    │
│   │     - Firecrawl로 스크래핑                               │    │
│   │     - LLM으로 데이터 정제                                │    │
│   │     - 결과 저장                                          │    │
│   │     - 내보내기 (Google Sheets 등)                        │    │
│   └─────────────────────────────────────────────────────────┘    │
│                              │                                    │
│                              ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │  4. 완료 처리                                            │    │
│   │     - usage_count 증가                                   │    │
│   │     - 알림 발송 (이메일/Slack)                           │    │
│   │     - 에러 시 재시도 또는 알림                           │    │
│   └─────────────────────────────────────────────────────────┘    │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 5. 배포 아키텍처

### 5.1 Phase 1: MVP (Vercel + Railway)

```
┌─────────────────────────────────────────────────────────────────┐
│                         Vercel                                   │
│  ┌────────────────────────────────────────────────────────┐     │
│  │                    Next.js App                          │     │
│  │  - SSR/SSG 페이지                                       │     │
│  │  - Edge Functions (API 프록시)                          │     │
│  │  - 정적 자산 (CDN)                                      │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Railway                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  FastAPI    │  │  Celery     │  │  Celery     │             │
│  │  Service    │  │  Worker     │  │  Beat       │             │
│  │  (API)      │  │  (x2~4)     │  │  (스케줄)   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  PostgreSQL │  │    Redis    │  │  Firecrawl  │             │
│  │  (DB)       │  │  (캐시/큐)  │  │  (스크래핑) │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

#### Railway 서비스 구성

```yaml
# railway.yaml

services:
  api:
    builder: DOCKERFILE
    healthcheck: /health
    envVars:
      DATABASE_URL: ${{Postgres.DATABASE_URL}}
      REDIS_URL: ${{Redis.REDIS_URL}}
    scaling:
      min: 1
      max: 3
  
  worker:
    builder: DOCKERFILE
    command: celery -A app.workers.celery_app worker --loglevel=info
    scaling:
      min: 2
      max: 8
    envVars:
      DATABASE_URL: ${{Postgres.DATABASE_URL}}
      REDIS_URL: ${{Redis.REDIS_URL}}
  
  beat:
    builder: DOCKERFILE
    command: celery -A app.workers.celery_app beat --loglevel=info
    scaling:
      min: 1
      max: 1
  
  firecrawl:
    image: mendableai/firecrawl:latest
    envVars:
      PORT: 3002
```

### 5.2 Phase 2+: 스케일 아웃 (AWS 마이그레이션)

```
┌─────────────────────────────────────────────────────────────────┐
│                        CloudFront                                │
│                     (CDN + WAF)                                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   Vercel        │ │   ALB           │ │   API Gateway   │
│   (Frontend)    │ │   (API LB)      │ │   (Webhooks)    │
└─────────────────┘ └────────┬────────┘ └─────────────────┘
                             │
                             ▼
            ┌────────────────────────────────┐
            │           ECS Fargate          │
            │  ┌──────────┐  ┌──────────┐   │
            │  │ FastAPI  │  │ FastAPI  │   │
            │  │ (x2~10)  │  │ (x2~10)  │   │
            │  └──────────┘  └──────────┘   │
            └────────────────────────────────┘
                             │
                             ▼
            ┌────────────────────────────────┐
            │        ElastiCache Redis       │
            │         (클러스터 모드)        │
            └────────────────────────────────┘
                             │
                             ▼
            ┌────────────────────────────────┐
            │       ECS Fargate Workers      │
            │  ┌──────────┐  ┌──────────┐   │
            │  │ Celery   │  │ Celery   │   │
            │  │ Workers  │  │ Workers  │   │
            │  │ (Auto)   │  │ (Auto)   │   │
            │  └──────────┘  └──────────┘   │
            └────────────────────────────────┘
                             │
                             ▼
            ┌────────────────────────────────┐
            │          RDS PostgreSQL        │
            │         (Multi-AZ)             │
            └────────────────────────────────┘
```

---

## 6. 보안 고려사항

### 6.1 인증/인가

```
┌─────────────────────────────────────────────────────────────────┐
│                        인증 흐름                                 │
└─────────────────────────────────────────────────────────────────┘

1. JWT 기반 인증
   ┌─────────┐    ┌─────────┐    ┌─────────┐
   │ 로그인  │───▶│ JWT     │───▶│ Access  │ (15분)
   │         │    │ 발급    │    │ Token   │
   └─────────┘    └─────────┘    └─────────┘
                        │
                        ▼
                  ┌─────────┐
                  │ Refresh │ (7일, HttpOnly Cookie)
                  │ Token   │
                  └─────────┘

2. API 요청 시
   ┌─────────────────────────────────────────────────────────────┐
   │  Authorization: Bearer <access_token>                        │
   │                                                              │
   │  - 토큰 검증                                                 │
   │  - 사용자 정보 추출                                          │
   │  - Rate Limit 체크 (플랜별)                                  │
   │  - 권한 확인 (리소스 소유권)                                 │
   └─────────────────────────────────────────────────────────────┘
```

### 6.2 데이터 보안

| 항목 | 방법 |
|------|------|
| 비밀번호 | bcrypt 해싱 |
| API 키 | AES-256 암호화 저장 |
| OAuth 토큰 | 암호화 저장, 필요시만 복호화 |
| 민감 설정 | 환경변수 또는 Secret Manager |
| 통신 | HTTPS only |
| SQL Injection | SQLAlchemy ORM 사용 |
| XSS | React 자동 이스케이프 + CSP |

### 6.3 Rate Limiting

```python
# utils/rate_limiter.py

from fastapi import Request
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

# 플랜별 제한
RATE_LIMITS = {
    'free': '10/minute',
    'starter': '30/minute',
    'pro': '100/minute',
    'enterprise': '500/minute',
}

def get_rate_limit(user):
    return RATE_LIMITS.get(user.plan, '10/minute')
```

---

## 7. 모니터링 및 로깅

### 7.1 로깅 전략

```python
# 구조화된 로깅
import structlog

logger = structlog.get_logger()

# 실행 로그
logger.info(
    "scraping_started",
    bot_id=bot_id,
    execution_id=execution_id,
    url=start_url,
)

logger.info(
    "page_scraped",
    execution_id=execution_id,
    url=page_url,
    rows_extracted=len(data),
    duration_ms=elapsed,
)

logger.error(
    "scraping_failed",
    execution_id=execution_id,
    error=str(e),
    traceback=traceback.format_exc(),
)
```

### 7.2 메트릭

| 메트릭 | 설명 | 알림 조건 |
|--------|------|----------|
| `execution_duration` | 실행 소요 시간 | > 5분 |
| `execution_success_rate` | 성공률 | < 95% |
| `queue_size` | 대기 중인 작업 수 | > 1000 |
| `worker_count` | 활성 워커 수 | < 2 |
| `error_rate` | 에러 비율 | > 5% |
| `api_latency_p99` | API 응답 시간 | > 500ms |

### 7.3 모니터링 스택

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1 (MVP)                                                   │
│  - Flower: Celery 모니터링                                       │
│  - Railway Metrics: 기본 인프라 모니터링                         │
│  - Sentry: 에러 추적                                             │
│  - Uptime Robot: 가동시간 모니터링                               │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Phase 2+ (스케일)                                               │
│  - Prometheus + Grafana: 메트릭 수집/시각화                      │
│  - ELK Stack: 로그 수집/분석                                     │
│  - PagerDuty: 알림                                               │
│  - AWS CloudWatch: 인프라 모니터링                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 확장성 고려사항

### 8.1 수평 확장 포인트

| 컴포넌트 | 확장 방법 | 고려사항 |
|---------|---------|----------|
| API 서버 | 인스턴스 추가 | Stateless 설계 필수 |
| Celery Worker | 워커 수 증가 | 메모리 주의 (브라우저) |
| Redis | 클러스터 모드 | 키 분산 전략 |
| PostgreSQL | Read Replica | 쓰기는 Primary만 |
| Firecrawl | 인스턴스 추가 | 프록시 풀 공유 |

### 8.2 예상 부하 및 용량

```
┌─────────────────────────────────────────────────────────────────┐
│  MVP 기준 (100명 유료 사용자)                                    │
├─────────────────────────────────────────────────────────────────┤
│  - 일일 실행 수: ~500회                                         │
│  - 동시 실행: ~20개                                             │
│  - 월간 행 수집: ~500,000행                                     │
│  - API 요청: ~50,000/일                                         │
│                                                                  │
│  필요 리소스:                                                    │
│  - API: 1 인스턴스 (1 vCPU, 1GB)                                │
│  - Worker: 2-4 인스턴스 (2 vCPU, 4GB each)                      │
│  - Redis: 256MB                                                  │
│  - PostgreSQL: 10GB                                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  성장 단계 (1,000명 유료 사용자)                                 │
├─────────────────────────────────────────────────────────────────┤
│  - 일일 실행 수: ~5,000회                                       │
│  - 동시 실행: ~200개                                            │
│  - 월간 행 수집: ~5,000,000행                                   │
│  - API 요청: ~500,000/일                                        │
│                                                                  │
│  필요 리소스:                                                    │
│  - API: 3-5 인스턴스 (Auto-scaling)                             │
│  - Worker: 10-20 인스턴스 (Auto-scaling)                        │
│  - Redis: 2GB (클러스터)                                        │
│  - PostgreSQL: 100GB (Multi-AZ)                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 다음 단계

### 즉시
1. [ ] 프로젝트 디렉토리 구조 생성
2. [ ] 기본 Docker 설정
3. [ ] 개발 환경 구성 (docker-compose)

### 설계 문서
4. [ ] API 명세서 (OpenAPI/Swagger)
5. [ ] 데이터베이스 마이그레이션 계획
6. [ ] 환경별 설정 가이드

---

*이 문서는 개발 진행에 따라 업데이트됩니다.*
